{% extends "admin/base_site.html" %}
{% load i18n admin_urls static custom_filters %}

{% block extrastyle %}
{{ block.super }}
<link rel="stylesheet" type="text/css" href="{% static 'admin/css/forms.css' %}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
<link rel="stylesheet" type="text/css" href="{% static 'admin/css/base.css' %}">
<link rel="stylesheet" type="text/css" href="{% static 'admin/css/widgets.css' %}">
{% comment %}
<link rel="stylesheet" type="text/css" href="{% static 'admin/css/frequencia.css' %}">
{% endcomment %}
<style>
/* Layout Geral */
#changelist table {
    width: 100%;
    border-collapse: collapse;
}

#changelist .button {
    padding: 6px 12px;
    background-color: #417690;
    color: white;
    border-radius: 4px;
    text-decoration: none;
    transition: background-color 0.2s;
}

#changelist .button:hover {
    background-color: #205067;
}

.frequencia-container {
    display: flex;
    gap: 30px;
}

.frequencia-left {
    flex: 1;
    max-width: 300px;
}

.frequencia-right {
    flex: 2;
}

.divider {
    border-top: 1px solid #ddd;
    margin: 15px 0;
}

/* Cabeçalho e Metadados */
.frequencia-header {
    margin-bottom: 20px;
}

.frequencia-meta {
    margin-bottom: 15px;
    width: 50%;
}

.frequencia-meta p {
    margin: 0;
}

/* Calendário */
.calendar-container {
    max-width: 100%;
    margin-bottom: 20px;
    border: 1px solid #ddd;
    border-radius: 4px;
    overflow: hidden;
}

.calendar-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 10px;
    background-color: #f5f5f5;
    border-radius: 4px 4px 0 0;
}

.calendar-header h4 {
    margin: 0;
    font-size: 1.2rem;
    font-weight: bold;
    color: #333;
    flex-grow: 1;
    text-align: center;
}

.calendar-header button {
    background: none;
    border: none;
    cursor: pointer;
    font-size: 1.2rem;
    color: #666;
    padding: 6px 8px;
    border-radius: 4px;
    transition: color 0.2s, background-color 0.15s;
}

.calendar-header button:hover {
    color: #333;
    background-color: rgba(175, 175, 175, 0.15);
}

.calendar-header button .fas {
    font-size: 14px;
}

.calendar-weekdays {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    background-color: #f5f5f5;
    text-align: center;
    font-weight: bold;
    padding: 5px 0;
    font-size: 12px;
}

.calendar-days {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 1px;
    background-color: #e0e0e0;
}

.calendar-day {
    padding: 6px;
    text-align: center;
    background-color: white;
    cursor: pointer;
    min-height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background-color 0.2s;
}

.calendar-day:hover {
    background-color: #f0f0f0;
}

.calendar-day.other-month {
    color: #ccc;
    background-color: #f9f9f9;
}

.calendar-day.today {
    background-color: #4a6fa5;
    font-weight: bold;
    color: #FFF;
}

.calendar-day.selected {
    background-color: #3afc43;
    color: black;
    font-size: 16px;
    font-weight:bolder;
    border: 1px solid #004a9e;
}

.calendar-day.letivo {
    background-color: rgba(138, 229, 246, 0.34); /* Verde claro para dias letivos */
}

/* Estilo para dias não letivos */
.calendar-day.nao-letivo {
    background-color: #f8f8f8;
    color: #666;
    cursor: not-allowed;
}

/* Estilo para feriados */
.calendar-day.feriado {
    background-color: #ffcccc;
    color: #666;
    cursor: not-allowed;
}

/* Estilo para fins de semana */
.calendar-day.fim-de-semana {
    background-color: #e6e6e6;
    color: #666;
    cursor: not-allowed;
}

/* Tooltip personalizado */
.calendar-day[title] {
    position: relative;
}

.calendar-day[title]:hover::after {
    content: attr(title);
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%);
    background: #333;
    color: #fff;
    padding: 5px 10px;
    border-radius: 4px;
    font-size: 12px;
    white-space: nowrap;
    z-index: 100;
}



.frequencia-date {
    font-size: 1.1em;
    margin-top: 10px;
    padding: 8px;
    background-color: #f8f8f8;
    border-radius: 4px;
    text-align: center;
}

/* Tabela de Frequência */
.frequencia-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
}

.frequencia-table th {
    background-color: #f5f5f5;
    text-align: left;
    padding: 8px;
    border-bottom: 1px solid #ddd;
}

.frequencia-table td {
    padding: 8px;
    border-bottom: 1px solid #eee;
    vertical-align: middle;
}

.aluno-status {
    font-size: 0.8em;
    color: #666;
    font-style: italic;
    display: flex;
    align-items: center;
    gap: 5px;
}

.ativo-dot {
    display: inline-block;
    width: 10px;
    height: 10px;
    background-color: #4CAF50; /* Verde */
    border-radius: 50%;
}

.inativo-dot {
    display: inline-block;
    width: 10px;
    height: 10px;
    background-color: #F44336; /* Vermelho */
    border-radius: 50%;
}

/* Ícones de Presença */
.presenca-options {
    display: flex;
    gap: 5px;
}

.presenca-icon {
    display: inline-block;
    width: 24px;
    height: 24px;
    line-height: 20px;
    border-radius: 50%;
    text-align: center;
    font-weight: bold;
    cursor: pointer;
    margin: 0 2px;
    background-color: #d3d3d3;
    color: white;
    transition: all 0.2s;
}

.presenca-icon:hover {
    transform: scale(1.1);
}

.presenca-icon.presenca-selected {
    font-weight: bold;
    transform: scale(1.2);
    box-shadow: 0 0 0 2px #2196F3;
}

.presenca-icon.presenca-selected.P {
    background-color: #4CAF50; /* Presente */
    color: white;
}

.presenca-icon.presenca-selected.A {
    background-color: #F44336; /* Ausente */
    color: white;
}

.presenca-icon.presenca-selected.J {
    background-color: #FFC107; /* Justificado */
    color: black;
}

.presenca-icon.presenca-selected.N {
    background-color: #9E9E9E; /* Não Letivo */
    color: white;
}

/* Ações e Botões */
.frequencia-actions {
    margin: 15px 0;
    display: flex;
    gap: 20px;
    align-items: center;
}

.frequencia-actions label {
    display: block;
    margin: 10px 0;
}

.frequencia-save {
    text-align: right;
    flex: 1;
}

.marcar-todos {
    display: flex;
    flex: 2;
    align-items: center;
    gap: 10px;
    margin-bottom: 15px;
}

.marcar-todos .btn-link {
    text-decoration: none;
    transition: all 0.2s;
}

.marcar-todos .btn-link:hover {
    text-decoration: underline;
    transform: translateY(-1px);
}

/* Legenda */
.frequencia-legenda {
    margin: 20px 0;
}

.frequencia-legenda ul {
    margin: 5px 0;
    padding-left: 20px;
}

.legenda-linha {
    display: flex;
    gap: 15px;
    margin-top: 5px;
}

.legenda-item {
    display: flex;
    align-items: center;
    gap: 5px;
}

/* Utilitários */
.sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border-width: 0;
}

/* Estilos para a legenda do calendário */
.calendar-legend {
    margin-top: 15px;
    padding: 10px;
    background-color: #f8f8f8;
    border-radius: 4px;
    border: 1px solid #eee;
}

.calendar-legend h4 {
    margin: 0 0 10px 0;
    font-size: 14px;
    color: #333;
}

.legend-items {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
}

.legend-item {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 13px;
}
</style>
{% endblock %}

{% block breadcrumbs %}
<div class="breadcrumbs">
<a href="{% url 'admin:index' %}">{% translate 'Home' %}</a>
› <a href="{% url 'admin:app_list' app_label='core' %}">Core</a>
› <a href="{% url 'admin:core_turma_changelist' %}">Turmas</a>
› Registro de Frequência
</div>
{% endblock %}

{% block content %}
<div id="content-main">
    <div class="frequencia-header">
        <h1>Núcleo: {{ turma.escola.diretoria_ensino|default:"Registro" }}</h1>
        <div class="frequencia-meta">
            <p><strong>Escola:</strong> {{ turma.escola.nome }}</p>
        </div>
    </div>

    <div class="divider"></div>

    <form method="post" id="frequencia-form">
        {% csrf_token %}
        <input type="hidden" name="status_data" id="status-data" value="">

        <div class="frequencia-container">
            <div class="frequencia-left">
                <div class="form-row">
                    <p>Selecione um ou mais dias!</p>
                    <div class="calendar-container">
                        <div class="calendar-header">
                            <button type="button" class="prev-month">
                                <i class="fas fa-angle-double-left"></i>
                            </button>
                            <h4 class="current-month-year"></h4>
                            <button type="button" class="next-month">
                                <i class="fas fa-angle-double-right"></i>
                            </button>
                        </div>
                        <div class="calendar-grid">
                            <div class="calendar-weekdays">
                                <div>Dom</div>
                                <div>Seg</div>
                                <div>Ter</div>
                                <div>Qua</div>
                                <div>Qui</div>
                                <div>Sex</div>
                                <div>Sáb</div>
                            </div>
                            <div class="calendar-days"></div>
                        </div>
                    </div>
                    <div class="frequencia-date">
                        <strong>Data Selecionada:</strong> {{ data_selecionada|date:"d / m / Y" }}
                    </div>

                    <div class="calendar-legend">
                        <h4>Legenda do Calendário:</h4>
                        <div class="legend-items">
                            <div class="legend-item">
                                <span class="legenda-item"><span style="display: inline-block; width: 10px; height: 10px; background-color: #8ae5f6; border-radius: 50%;"></span> Dia Letivo</span>
                            </div>
                            <div class="legend-item">
                                <span class="legenda-item"><span style="display: inline-block; width: 10px; height: 10px; background-color: #d3d3d3; border-radius: 50%;"></span> Dia Não Letivo</span>
                            </div>
                            <div class="legend-item">
                                <span class="legenda-item"><span style="display: inline-block; width: 10px; height: 10px; background-color: #ffcccc; border-radius: 50%;"></span> Feriado</span>
                            </div>
                            <div class="legend-item">
                                <span class="legenda-item"><span style="display: inline-block; width: 10px; height: 10px; background-color: #e6e6e6; border-radius: 50%;"></span> Fim de Semana</span>
                            </div>
                            <div class="legend-item">
                                <span class="legenda-item"><span style="display: inline-block; width: 10px; height: 10px; background-color: #ffffff; border: 1px solid #ccc; border-radius: 50%;"></span> Dia de Outro Mês</span>
                            </div>
                            <div class="legend-item">
                                <span class="legenda-item"><span style="display: inline-block; width: 10px; height: 10px; background-color: #4a6fa5; border-radius: 50%;"></span> Dia Atual</span>
                            </div>
                            <div class="legend-item">
                                <span class="legenda-item"><span style="display: inline-block; width: 10px; height: 10px; background-color: #4CAF50; border-radius: 50%;"></span> Dia Selecionado</span>
                            </div>
                        </div>
                    </div>

                    <input type="hidden" name="data" id="selected-date" value="{{ data_selecionada|date:'Y-m-d' }}" required>
                 </div>
            </div>

            <div class="frequencia-right">
                <div class="frequencia-actions">
                    <label class="checkbox">
                        <input type="checkbox" name="mostrar_inativos"> Mostrar Ativos e Inativos
                    </label>
                </div>

                <div class="marcar-todos mb-3">
                    <span class="me-2">Marcar todos como:</span>
                    <div class="d-flex align-items-center" style="gap: 10px;">
                        {% for choice in opcoes_status %}
                        <span class="marcar-todos-btn presenca-icon
                                     {% if choice.0 == 'presente' %}P
                                     {% elif choice.0 == 'ausente' %}A
                                     {% elif choice.0 == 'justificado' %}J
                                     {% else %}N{% endif %} presenca-selected"
                              data-status="{{ choice.0 }}"
                              title="{{ choice.1 }}">
                            {{ choice.0|first|upper }}
                        </span>
                        {% endfor %}
                    </div>
                    <div class="frequencia-save">
                        <button type="submit" class="button add-alunos-btn">Salvar</button>
                    </div>
                </div>
                <div class="results">
                    <table class="frequencia-table">
                        <thead>
                            <tr>
                                <th>Nº</th>
                                <th>ALUNO</th>
                                <th>PRESENÇA</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for aluno in alunos %}
                            <tr class="{% cycle 'row1' 'row2' %}">
                                <td>{{ forloop.counter }}</td>
                                <td>
                                    <strong>{{ aluno.nome }}</strong>
                                    <div class="aluno-status">
                                        {% if aluno.ativo %}
                                            <span class="ativo-dot"></span> Aluno ativo
                                        {% else %}
                                            <span class="inativo-dot"></span> Aluno inativo
                                        {% endif %}
                                    </div>
                                </td>
                                <td>
                                    <div class="presenca-options" data-aluno-id="{{ aluno.id }}">
                                        {% for choice in opcoes_status %}
                                        <span class="presenca-icon
                                            {% if frequencias_dict|get_item:aluno.id|stringformat:"s" == choice.0 %}presenca-selected{% endif %}"
                                            data-status="{{ choice.0 }}"
                                            data-type="{% if choice.0 == 'presente' %}P{% elif choice.0 == 'ausente' %}A{% elif choice.0 == 'justificado' %}J{% else %}N{% endif %}"
                                            title="{{ choice.1 }}">
                                            {{ choice.0|first|upper }}
                                        </span>
                                        {% endfor %}
                                        <input type="hidden" name="status_{{ aluno.id }}" value="{% if frequencias_dict|get_item:aluno.id|stringformat:'s' %}{{ frequencias_dict|get_item:aluno.id|stringformat:'s'}}{% endif %}">
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>

                    <div class="frequencia-legenda">
                        <h3>Legenda:</h3>
                        <div class="legenda-linha">
                            <span class="legenda-item"><span class="presenca-icon P presenca-selected">P</span> Presente</span>
                            <span class="legenda-item"><span class="presenca-icon A presenca-selected">A</span> Ausente</span>
                            <span class="legenda-item"><span class="presenca-icon J presenca-selected">J</span> Justificado</span>
                            <span class="legenda-item"><span class="presenca-icon N presenca-selected">N</span> Não Letivo</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>
<script>
// Retorna true se a data for feriado nacional (exemplo via lista estática ou API)
async function isFeriado(date) {
    const ano = date.getFullYear();
    const feriados = await fetchFeriados(ano);
    const dataStr = formatDate(date);
    return feriados.includes(dataStr);
}

// Busca feriados do ano atual via API externa
async function fetchFeriados(ano) {
    try {
        const response = await fetch(`https://brasilapi.com.br/api/feriados/v1/${ano}`);
        if (!response.ok) throw new Error('Erro ao buscar feriados');
        const data = await response.json();
        return data.map(f => f.date); // ['2025-01-01', '2025-04-21', ...]
    } catch (err) {
        console.error('Erro buscando feriados:', err);
        return [];
    }
}

// Função para verificar se uma data pode ser letiva
async function isDiaLetivoValido(date) {
    const isWeekendDay = isWeekend(date);
    const isFeriadoDay = await isFeriado(date);
    const isLetivoFromBackend = await isLetivo(date);
    return !isWeekendDay && !isFeriadoDay && isLetivoFromBackend;
}

// Função para verificar se é fim de semana (sábado ou domingo)
function isWeekend(date) {
    const day = date.getDay();
    return day === 0 || day === 6; // 0 = Domingo, 6 = Sábado
}

// Função para buscar dias letivos do backend
async function fetchDiasLetivos() {
    try {
        const response = await fetch('/api/dias-letivos/', {
            method: 'GET',
            headers: {
                'X-CSRFToken': getCsrfToken(),
                'Content-Type': 'application/json'
            }
        });
        if (!response.ok) {
            throw new Error('Erro ao buscar dias letivos: ' + response.status);
        }
        const data = await response.json();
        console.log("Dias letivos recebidos:", data);
        return data.dias_letivos; // Espera-se um array de objetos { data: "YYYY-MM-DD", status: "L" }
    } catch (error) {
        console.error("Erro ao buscar dias letivos:", error);
        return [];
    }
}

// Função auxiliar para obter o token CSRF
function getCsrfToken() {
    const cookieValue = document.cookie
        .split('; ')
        .find(row => row.startsWith('csrftoken='))
        ?.split('=')[1];
    return cookieValue || '';
}

// Verifica se uma data é letiva com base nos dados do backend
async function isLetivo(date) {
    const diasLetivos = await fetchDiasLetivos();
    const dateStr = formatDate(date);

    // Verifica se a data está na lista de dias letivos com status 'L'
    return diasLetivos.some(dia => dia.data === dateStr && dia.status === 'L');
}

// Formata data como YYYY-MM-DD
function formatDate(date) {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
}

// Obtém o nome do mês
function getMonthName(month) {
    const monthNames = [
        'Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho',
        'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
    ];
    return monthNames[month];
}

// Renderiza o calendário para um mês específico
async function renderCalendar(year, month) {
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const daysInMonth = lastDay.getDate();

    const calendarDays = document.querySelector('.calendar-days');
    calendarDays.innerHTML = '';

    // Exibe o mês e ano no topo
    document.querySelector('.current-month-year').textContent = `${getMonthName(month)} ${year}`;

    // Obter a data selecionada do campo hidden
    const selectedDateStr = document.getElementById('selected-date').value;
    let selectedDate = null;

    if (selectedDateStr) {
        const [year, month, day] = selectedDateStr.split('-').map(Number);
        selectedDate = new Date(year, month - 1, day);
        console.log("Data selecionada para comparação:", selectedDate);
    }

    // Dias da semana do primeiro dia do mês
    let dayOfWeek = firstDay.getDay();

    // Dias do mês anterior
    const prevMonthLastDay = new Date(year, month, 0).getDate();
    for (let i = dayOfWeek - 1; i >= 0; i--) {
        const day = prevMonthLastDay - i;
        const date = new Date(year, month - 1, day);
        const dayElement = createDayElement(date, true);
        calendarDays.appendChild(dayElement);
    }

    // Dias do mês atual
    const today = new Date();

    for (let day = 1; day <= daysInMonth; day++) {
        const date = new Date(year, month, day);
        const isToday = date.toDateString() === today.toDateString();

        // Verificar se é a data selecionada
        const isSelected = selectedDate ? date.toDateString() === selectedDate.toDateString() : false;
        const letivo = await isLetivo(date);

        console.log(`Dia ${day}:`, date, "Selecionado?", isSelected, "Letivo?", letivo);

        const dayElement = createDayElement(date, false, isToday, isSelected, letivo);
        calendarDays.appendChild(dayElement);
    }

    // Dias do próximo mês para completar a grade
    const daysToAdd = 42 - (dayOfWeek + daysInMonth);
    for (let day = 1; day <= daysToAdd; day++) {
        const date = new Date(year, month + 1, day);
        const dayElement = createDayElement(date, true);
        calendarDays.appendChild(dayElement);
    }
}

// Cria um elemento de dia para o calendário
function createDayElement(date, isOtherMonth, isToday = false, isSelected = false) {
    const dayElement = document.createElement('div');
    dayElement.className = 'calendar-day';
    dayElement.textContent = date.getDate();

    const dateStr = formatDate(date);

    if (isOtherMonth) {
        dayElement.classList.add('other-month', 'disabled');
    } else if (isToday) {
        dayElement.classList.add('today');
    }

    if (isSelected) {
        dayElement.classList.add('selected');
    }

    if (!isOtherMonth) {
        isDiaLetivoValido(date).then(async podeSelecionar => {
            const fimDeSemana = isWeekend(date);
            const feriado = await isFeriado(date);
            const letivo = await isLetivo(date);

            if (podeSelecionar) {
                dayElement.classList.add('letivo');
                dayElement.addEventListener('click', function () {
                    document.querySelectorAll('.calendar-day.selected').forEach(el => el.classList.remove('selected'));
                    dayElement.classList.add('selected');
                    document.getElementById('selected-date').value = formatDate(date);
                    document.querySelector('.frequencia-date').textContent =
                        `${String(date.getDate()).padStart(2, '0')} / ${String(date.getMonth() + 1).padStart(2, '0')} / ${date.getFullYear()}`;
                });
            } else {
                dayElement.classList.add('disabled');

                if (feriado) {
                    dayElement.classList.add('feriado');
                    dayElement.title = 'Feriado';
                } else if (fimDeSemana) {
                    dayElement.classList.add('fim-de-semana');
                    dayElement.title = 'Fim de semana';
                } else if (!letivo) {
                    dayElement.classList.add('nao-letivo');
                    dayElement.title = 'Dia não letivo';
                }
            }
        });
    }

    return dayElement;
}

// Função para atualizar a URL sem recarregar
function updateUrlWithDate(date) {
    const url = new URL(window.location.href);
    url.searchParams.set('data', formatDate(date));
    window.history.replaceState({}, '', url);
}

// Navegação do calendário
let currentDate = new Date();
const selectedDateInput = document.getElementById('selected-date');

if (selectedDateInput.value) {
    try {
        const [year, month, day] = selectedDateInput.value.split('-').map(Number);
        currentDate = new Date(year, month - 1, day);
        console.log("Data inicial do calendário:", currentDate);
    } catch (e) {
        console.error("Erro ao parsear data selecionada:", e);
    }
}

// Função para atualizar as classes de estilo com base na seleção
function updateIconStyles(container) {
    container.querySelectorAll('.presenca-icon').forEach(icon => {
        const type = icon.dataset.type;
        if (icon.classList.contains('presenca-selected')) {
            icon.classList.remove('P', 'A', 'J', 'N');
            icon.classList.add(type);
        } else {
            icon.classList.remove('P', 'A', 'J', 'N');
        }
    });
}

// Inicializar estilos ao carregar a página
document.querySelectorAll('.presenca-options').forEach(container => {
    updateIconStyles(container);
});

// Selecionar status para um aluno
document.querySelectorAll('.presenca-icon').forEach(icon => {
    icon.addEventListener('click', function() {
        const container = this.closest('.presenca-options');
        const status = this.dataset.status;
        const inputHidden = container.querySelector('input[type="hidden"]');

        container.querySelectorAll('.presenca-icon').forEach(i => {
            i.classList.remove('presenca-selected');
        });

        this.classList.add('presenca-selected');
        inputHidden.value = status;
        updateIconStyles(container);
    });
});

// Marcar todos os alunos com um status
document.querySelectorAll('.marcar-todos-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        const status = this.dataset.status;
        document.querySelectorAll('.presenca-options').forEach(container => {
            const icon = container.querySelector(`.presenca-icon[data-status="${status}"]`);
            const inputHidden = container.querySelector('input[type="hidden"]');

            container.querySelectorAll('.presenca-icon').forEach(i => {
                i.classList.remove('presenca-selected');
            });

            if (icon) {
                icon.classList.add('presenca-selected');
                inputHidden.value = status;
                updateIconStyles(container);
            }
        });
    });
});

// Enviar formulário
document.getElementById('frequencia-form').addEventListener('submit', function(e) {
    e.preventDefault(); // Impede o envio padrão para depuração

    const statusData = {};
    document.querySelectorAll('.presenca-options').forEach(container => {
        const alunoId = container.dataset.alunoId;
        const inputHidden = container.querySelector('input[type="hidden"]');
        if (inputHidden.value) {
            statusData[alunoId] = inputHidden.value;
            // Garante que o campo individual seja atualizado
            const statusInput = document.querySelector(`input[name="status_${alunoId}"]`);
            if (statusInput) {
                statusInput.value = inputHidden.value;
            }
        }
    });

    document.getElementById('status-data').value = JSON.stringify(statusData);

    const formData = new FormData(this);
    console.log("Dados do formulário antes do submit:");
    for (let [key, value] of formData.entries()) {
        console.log(key, value);
    }

    // Envia o formulário após depuração
    this.submit();
});

// Função para extrair a data da URL
function getDateFromUrl() {
    const urlParams = new URLSearchParams(window.location.search);
    const dateParam = urlParams.get('data');
    if (dateParam) {
        try {
            const [year, month, day] = dateParam.split('-').map(Number);
            const date = new Date(year, month - 1, day);
            if (isNaN(date.getTime())) {
                throw new Error("Data inválida");
            }
            const adjustedDate = new Date(date.getTime() + date.getTimezoneOffset() * 60000);
            console.log("Data da URL ajustada:", adjustedDate);
            return adjustedDate;
        } catch (e) {
            console.error("Erro ao parsear data da URL:", e);
            return null;
        }
    }
    return null;
}

// Inicialização do calendário
async function initCalendar() {
    let currentDate = getDateFromUrl();

    if (!currentDate && document.getElementById('selected-date').value) {
        try {
            const [year, month, day] = document.getElementById('selected-date').value.split('-').map(Number);
            currentDate = new Date(year, month - 1, day);
        } catch (e) {
            console.error("Erro ao parsear data do campo hidden:", e);
        }
    }

    if (!currentDate) {
        currentDate = new Date();
    }

    console.log("Inicializando calendário com data:", currentDate);

    const formattedDate = formatDate(currentDate);
    document.getElementById('selected-date').value = formattedDate;

    updateDateDisplay(currentDate);
    await renderCalendar(currentDate.getFullYear(), currentDate.getMonth());
    setupCalendarNavigation(currentDate);
}

// Função auxiliar para atualizar a exibição da data
function updateDateDisplay(date) {
    const dateElement = document.querySelector('.frequencia-date');
    if (dateElement) {
        dateElement.textContent =
            `${String(date.getDate()).padStart(2, '0')} / ${String(date.getMonth() + 1).padStart(2, '0')} / ${date.getFullYear()}`;
    }
}

// Função auxiliar para configurar navegação
function setupCalendarNavigation(currentDate) {
    document.querySelector('.prev-month').addEventListener('click', async function() {
        currentDate.setMonth(currentDate.getMonth() - 1);
        await renderCalendar(currentDate.getFullYear(), currentDate.getMonth());
    });

    document.querySelector('.next-month').addEventListener('click', async function() {
        currentDate.setMonth(currentDate.getMonth() + 1);
        await renderCalendar(currentDate.getFullYear(), currentDate.getMonth());
    });
}

console.log("Script de frequência carregado");
initCalendar();
</script>
{% endblock %}