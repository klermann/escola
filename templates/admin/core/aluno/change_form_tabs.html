{% extends "admin/change_form.html" %}
{% load i18n admin_urls static admin_modify %}

{% block extrahead %}
  {{ block.super }}
  <style>
    /* ===== Abas: remove marcadores do UL e resets ===== */
    #content .tabs > ul,
    #content .tabs > ul li {
      list-style: none !important;
      list-style-type: none !important;
      list-style-image: none !important;
      padding-left: 0 !important;
      margin-left: 0 !important;
    }
    #content .tabs > ul li::marker { content: "" !important; }
    #content .tabs > ul li::before { content: none !important; }

    /* ===== Layout das abas ===== */
    .tabs { margin: 20px 0; }
    .tabs > ul {
      display: flex;
      gap: 10px;
      border-bottom: 1px solid #d9d9d9;
      margin: 0 0 16px !important;
      flex-wrap: wrap;
    }
    .tabs > ul li { margin: 0; }
    .tabs > ul a[role="tab"] {
      display: block;
      padding: 8px 14px;
      background: #f5f5f5;
      color: #333;
      text-decoration: none;
      border: 1px solid #d9d9d9;
      border-bottom: none;
      border-radius: 6px 6px 0 0;
      outline: none;
    }
    .tabs > ul li.is-active a[role="tab"],
    .tabs > ul a[role="tab"]:focus {
      background: #79aec8;
      color: #fff;
      border-color: #79aec8;
    }

    /* ===== Conteúdo das abas ===== */
    .tab-content {
      display: none;               /* escondido por padrão */
      padding: 15px;
      border: 1px solid #d9d9d9;
      background: #fff;
    }
    .tab-content.is-active { display: block; }

    /* separador visual suave quando várias abas são ativas em sequência */
    .tab-content + .tab-content { margin-top: -1px; }

    /* ===== Desativa “(mostrar)” do admin para inlines/fieldsets colapsáveis ===== */
    .inline-group.collapse,
    fieldset.collapse { display: block !important; }
    .inline-group .collapse-toggle,
    fieldset .collapse-toggle { display: none !important; }

    /* ===== Realce de erro na guia ===== */
    .tabs > ul li.has-error a[role="tab"] {
      box-shadow: inset 0 -3px 0 #ba2121;
    }
  </style>
{% endblock %}

{% block content %}
  {{ block.super }}
  <script>
    (function ($) {
      function activateTab(id, pushHash) {
        // headers
        $('.tabs [role="tab"]').attr('aria-selected', 'false')
          .closest('li').removeClass('is-active');
        $('.tabs [href="' + id + '"]').attr('aria-selected', 'true')
          .closest('li').addClass('is-active');

        // contents
        $('.tab-content').removeClass('is-active').attr('aria-hidden', 'true');
        $(id).addClass('is-active').attr('aria-hidden', 'false');

        if (pushHash) {
          // atualiza a hash sem rolar a página
          if (history.replaceState) history.replaceState(null, '', id);
          else location.hash = id.substring(1);
        }
      }

      function openFirstTab() {
        var $first = $('.tabs [role="tab"]').first();
        activateTab($first.attr('href'), false);
      }

      function openTabFromHashOrErrors() {
        // 1) se houver erros, abre a aba que contém um .errors
        var $errorFieldset = $('.tab-content .errors, .tab-content .errornote').first();
        if ($errorFieldset.length) {
          var $pane = $errorFieldset.closest('.tab-content');
          activateTab('#' + $pane.attr('id'), true);
          // marca a aba com erro
          $('.tabs [href="#' + $pane.attr('id') + '"]').closest('li').addClass('has-error');
          return;
        }
        // 2) se houver hash (#tab-xxx), abre-a
        if (location.hash && $(location.hash).length) {
          activateTab(location.hash, false);
          return;
        }
        // 3) default: primeira
        openFirstTab();
      }

      $(function () {
        // Acessibilidade básica ARIA
        $('.tabs > ul').attr('role', 'tablist');
        $('.tabs > ul a').attr({ role: 'tab', tabindex: '0', 'aria-selected': 'false' });
        $('.tab-content').attr('role', 'tabpanel').attr('aria-hidden', 'true');

        // Clique nas abas
        $('.tabs').on('click', '[role="tab"]', function (e) {
          e.preventDefault();
          activateTab($(this).attr('href'), true);
        });

        // Teclado (← → Home End)
        $('.tabs').on('keydown', '[role="tab"]', function (e) {
          var $tabs = $('.tabs [role="tab"]');
          var idx = $tabs.index(this);
          if (e.key === 'ArrowRight') { e.preventDefault(); $tabs.eq((idx+1)%$tabs.length).focus().click(); }
          if (e.key === 'ArrowLeft')  { e.preventDefault(); $tabs.eq((idx-1+$tabs.length)%$tabs.length).focus().click(); }
          if (e.key === 'Home')       { e.preventDefault(); $tabs.first().focus().click(); }
          if (e.key === 'End')        { e.preventDefault(); $tabs.last().focus().click(); }
        });

        openTabFromHashOrErrors();
      });
    })(django.jQuery);
  </script>
{% endblock %}

{% block field_sets %}
  <div class="tabs">
    <ul>
      <li class="is-active"><a href="#tab-basico">{% trans "Dados básicos" %}</a></li>
      <li><a href="#tab-pessoais">{% trans "Dados pessoais" %}</a></li>
      <li><a href="#tab-resp">{% trans "Responsáveis" %}</a></li>
      <li><a href="#tab-contato">{% trans "Contatos" %}</a></li>
      <li><a href="#tab-escolar">{% trans "Escolares" %}</a></li>
      <li><a href="#tab-complementar">{% trans "Complementares" %}</a></li>
    </ul>

    <div id="tab-basico" class="tab-content is-active" aria-hidden="false">
      {% for fieldset in adminform %}
        {% include "admin/includes/fieldset.html" %}
      {% endfor %}
    </div>
{% endblock %}

{% block inline_field_sets %}
    <div id="tab-pessoais" class="tab-content">
      {% for inline_admin_formset in inline_admin_formsets %}
        {% if forloop.counter0 == 0 %}
          {% include inline_admin_formset.opts.template %}
        {% endif %}
      {% endfor %}
    </div>

    <div id="tab-resp" class="tab-content">
      {% for inline_admin_formset in inline_admin_formsets %}
        {% if forloop.counter0 == 1 %}
          {% include inline_admin_formset.opts.template %}
        {% endif %}
      {% endfor %}
    </div>

    <div id="tab-contato" class="tab-content">
      {% for inline_admin_formset in inline_admin_formsets %}
        {% if forloop.counter0 == 2 %}
          {% include inline_admin_formset.opts.template %}
        {% endif %}
      {% endfor %}
    </div>

    <div id="tab-escolar" class="tab-content">
      {% for inline_admin_formset in inline_admin_formsets %}
        {% if forloop.counter0 == 3 %}
          {% include inline_admin_formset.opts.template %}
        {% endif %}
      {% endfor %}
    </div>

    <div id="tab-complementar" class="tab-content">
      {% for inline_admin_formset in inline_admin_formsets %}
        {% if forloop.counter0 == 4 %}
          {% include inline_admin_formset.opts.template %}
        {% endif %}
      {% endfor %}
    </div>
  </div>
{% endblock %}
